name: Update Now Playing (Debug)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-now-playing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euo pipefail
          pip install lyricsgenius
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Debug Genius environment
        run: |
          set -euo pipefail

          echo "[DEBUG] Genius env vars present:"
          env | grep '^GENIUS_' || true

          if [ -z "${GENIUS_ACCESS_TOKEN:-}" ]; then
            echo "[ERROR] GENIUS_ACCESS_TOKEN is not set"
            exit 1
          fi

          echo "[DEBUG] GENIUS_ACCESS_TOKEN length: ${#GENIUS_ACCESS_TOKEN}"

        env:
          GENIUS_ACCESS_TOKEN: ${{ secrets.GENIUS_ACCESS_TOKEN }}

      - name: Get Spotify access token
        id: token
        run: |
          set -euo pipefail

          RESPONSE="$(curl -s -X POST "https://accounts.spotify.com/api/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${{ secrets.SPOTIFY_REFRESH_TOKEN }}" \
            -d "client_id=${{ secrets.SPOTIFY_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.SPOTIFY_CLIENT_SECRET }}")"

          echo "[DEBUG] Spotify token response keys:"
          echo "${RESPONSE}" | jq 'keys'

          ACCESS_TOKEN="$(echo "${RESPONSE}" | jq -r '.access_token')"
          printf 'access_token=%s\n' "${ACCESS_TOKEN}" >> "${GITHUB_OUTPUT}"

      - name: Fetch recently played
        id: recent
        run: |
          set -euo pipefail

          RESPONSE="$(curl -s -X GET \
            "https://api.spotify.com/v1/me/player/recently-played?limit=1" \
            -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}")"

          echo "[DEBUG] Spotify response:"
          echo "${RESPONSE}" | jq '.items[0].track | {name, artists}'

          TRACK="$(echo "${RESPONSE}" | jq -r '.items[0].track.name')"
          ARTIST="$(echo "${RESPONSE}" | jq -r '.items[0].track.artists[0].name')"

          printf 'track=%s\n' "${TRACK}" >> "${GITHUB_OUTPUT}"
          printf 'artist=%s\n' "${ARTIST}" >> "${GITHUB_OUTPUT}"

      - name: Fetch lyrics from Genius (verbose)
        id: lyrics
        env:
          GENIUS_ACCESS_TOKEN: ${{ secrets.GENIUS_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          TRACK="${{ steps.recent.outputs.track }}"
          ARTIST="${{ steps.recent.outputs.artist }}"

          echo "[DEBUG] Querying Genius:"
          echo "        Track : ${TRACK}"
          echo "        Artist: ${ARTIST}"

          RAW_LYRICS="$(
            python -m lyricsgenius song "${TRACK}" "${ARTIST}" 2>&1 || true
          )"

          echo "[DEBUG] Raw lyricsgenius output:"
          echo "------------------------------"
          echo "${RAW_LYRICS}"
          echo "------------------------------"

          LYRIC="$(
            printf '%s\n' "${RAW_LYRICS}" \
            | awk -v seed="${RANDOM}" '
                BEGIN { srand(seed) }
                /^[[:space:]]*$/ { next }
                /^[[:space:]]*\[/ { next }
                {
                  ++n
                  if (rand() < 1/n) {
                    pick = $0
                  }
                }
                END {
                  if (n > 0) print pick
                }
              ' \
            | sed -E '
                s/^[‚Äú‚Äù"'\''‚Äò‚Äô]+//;
                s/[‚Äú‚Äù"'\''‚Äò‚Äô]+$//;
                s/[‚Äò‚Äô]/'\''/g;
                s/[‚Äú‚Äù]/"/g;
                s/‚Äî/--/g;
                s/‚Äì/-/g;
                s/‚Ä¶/.../g
              '
          )"

          echo "[DEBUG] Selected lyric:"
          echo "${LYRIC:-<empty>}"

          printf 'lyric=%s\n' "${LYRIC}" >> "${GITHUB_OUTPUT}"

      - name: Update now-playing.txt
        run: |
          set -euo pipefail

          TRACK="${{ steps.recent.outputs.track }}"
          ARTIST="${{ steps.recent.outputs.artist }}"
          LYRIC="${{ steps.lyrics.outputs.lyric }}"

          if [ -n "${LYRIC}" ]; then
            printf '"%s"\n    ‚Äî %s by %s\n' \
              "${LYRIC}" "${TRACK}" "${ARTIST}" \
              > _includes/now-playing.txt
          else
            echo "[WARN] No lyric; writing fallback"
            printf 'üéµ %s\n    ‚Äî %s\n' \
              "${TRACK}" "${ARTIST}" \
              > _includes/now-playing.txt
          fi

      - name: Show final file
        run: |
          echo "[DEBUG] _includes/now-playing.txt"
          cat _includes/now-playing.txt
